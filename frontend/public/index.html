<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GEO Discoverer | AI Brand Visibility</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Vercel Analytics -->
  <script defer src="https://va.vercel-scripts.com/v1/script.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;700;800&display=swap"
    rel="stylesheet">
  <style>
    body {
      background-color: #0E1117;
      color: #FAFAFA;
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px
    }

    h1,
    h2,
    h3,
    .font-heading {
      font-family: 'Space Grotesk', sans-serif
    }

    .system-badge {
      font-family: 'Space Grotesk', monospace;
      background: rgba(37, 99, 235, 0.1);
      color: #60A5FA;
      border: 1px solid rgba(37, 99, 235, 0.2);
      padding: .5rem 1rem;
      border-radius: 4px;
      display: inline-block;
      font-size: .8rem;
      letter-spacing: .05em;
      margin-bottom: 1.5rem
    }

    .hero-title {
      font-size: 4rem;
      line-height: 1;
      font-weight: 800;
      letter-spacing: -.03em
    }

    .highlight-blue {
      color: #3B82F6;
      position: relative;
      z-index: 1
    }

    .highlight-blue::after {
      content: '';
      position: absolute;
      bottom: 10%;
      left: -5%;
      width: 110%;
      height: 30%;
      background: rgba(59, 130, 246, 0.2);
      z-index: -1;
      transform: rotate(-2deg)
    }

    .input-card {
      background-color: #161B22;
      border: 1px solid #30363D;
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px)
    }

    input,
    textarea,
    select {
      background-color: #0d1117;
      border: 1px solid #30363D;
      color: white;
      transition: all .2s
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: #3B82F6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
      outline: none
    }

    .vibrant-button {
      background: #2563EB;
      color: white;
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      border-radius: 9999px;
      transition: all .2s ease;
      box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.39)
    }

    .vibrant-button:hover {
      background: #1D4ED8;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.23)
    }

    .secondary-button {
      background: transparent;
      color: #9CA3AF;
      border: 1px solid #374151;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      border-radius: 9999px;
      transition: all .2s ease
    }

    .secondary-button:hover {
      color: white;
      border-color: #6B7280;
      background: rgba(255, 255, 255, 0.05)
    }

    .metric-card {
      background-color: #1F2937;
      border: 1px solid #374151;
      transition: transform .2s
    }

    .metric-card:hover {
      transform: translateY(-5px)
    }

    .geo-table th {
      background-color: #1F2937;
      color: #9CA3AF;
      font-family: 'Space Grotesk', sans-serif;
      font-size: .9rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      border-bottom: 2px solid #374151
    }

    .geo-table td {
      border-bottom: 1px solid #374151;
      padding-top: 1rem;
      padding-bottom: 1rem
    }

    .geo-table tr:hover td {
      background-color: #1c2128
    }

    .shape {
      position: absolute;
      opacity: .6;
      animation: float 6s ease-in-out infinite;
      z-index: -1
    }

    .shape-1 {
      top: 10%;
      left: 5%;
      width: 40px;
      height: 40px;
      background: #EF4444;
      transform: rotate(15deg)
    }

    .shape-2 {
      top: 20%;
      right: 10%;
      width: 30px;
      height: 30px;
      background: #F59E0B;
      border-radius: 50%;
      animation-delay: 1s
    }

    .shape-3 {
      bottom: 15%;
      left: 15%;
      width: 50px;
      height: 50px;
      background: #3B82F6;
      clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
      animation-delay: 2s
    }

    @keyframes float {
      0% {
        transform: translateY(0) rotate(0)
      }

      50% {
        transform: translateY(-20px) rotate(10deg)
      }

      100% {
        transform: translateY(0) rotate(0)
      }
    }

    .fade-in {
      animation: fadeIn .6s cubic-bezier(0.16, 1, 0.3, 1)
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .hidden {
      display: none
    }

    .code-window {
      background: #0D1117;
      border: 1px solid #30363D;
      border-radius: 8px;
      font-family: 'Monaco', monospace;
      font-size: .85rem;
      position: relative
    }

    .code-header {
      padding: .5rem 1rem;
      border-bottom: 1px solid #30363D;
      display: flex;
      gap: 6px
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%
    }

    .dot-red {
      background: #FF5F56
    }

    .dot-yellow {
      background: #FFBD2E
    }

    .dot-green {
      background: #27C93F
    }

    /* Skeleton loading animation */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .skeleton {
      background: linear-gradient(90deg, #1F2937 25%, #374151 50%, #1F2937 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    .skeleton-text {
      height: 1em;
      width: 100%;
    }

    .skeleton-text-sm {
      height: 0.75em;
      width: 60%;
    }

    /* Row fade-in animation */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .row-animate {
      animation: slideIn 0.4s ease-out forwards;
    }

    /* Pulse animation for updating values */
    @keyframes pulse-update {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .updating {
      animation: pulse-update 1s ease-in-out infinite;
    }

    /* Live indicator */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: #10B981;
      border-radius: 50%;
      animation: pulse-update 1s ease-in-out infinite;
    }

    @media print {
      @page {
        size: A4;
        margin: 10mm;
        background-color: #0E1117;
      }

      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      /* Hide everything by default */
      body>* {
        display: none !important;
      }

      /* Only show the dashboard and its specific children */
      body,
      #view-dashboard {
        background-color: #0E1117 !important;
        color: #FAFAFA !important;
        display: block !important;
        visibility: visible !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      /* Ensure dashboard children are visible */
      #view-dashboard * {
        display: block;
        /* Reset display for children, but let flex/grid override if needed via specific rules or cascading if not hidden */
        visibility: visible !important;
      }

      /* Restore specific layout displays for dashboard internals */
      #view-dashboard .grid {
        display: grid !important;
      }

      #view-dashboard .flex {
        display: flex !important;
      }

      #view-dashboard .hidden {
        display: none !important;
      }

      /* Keep hidden things hidden */

      /* Explicitly hide UI controls in dashboard */
      #downloadBtn,
      #newBtn,
      nav,
      .system-badge,
      #debugger,
      details>summary {
        display: none !important;
      }

      /* Styling fixes for print */
      .metric-card,
      .bg-\[\#161B22\] {
        break-inside: avoid;
        page-break-inside: avoid;
        background-color: #161B22 !important;
        border: 1px solid #374151 !important;
        box-shadow: none !important;
      }

      h1,
      h2,
      h3 {
        break-after: avoid;
        page-break-after: avoid;
      }

      table {
        width: 100% !important;
        border-collapse: collapse !important;
      }

      th,
      td {
        border: 1px solid #374151 !important;
      }

      /* Force text colors */
      .text-gray-400 {
        color: #9CA3AF !important;
      }

      .text-white {
        color: #FFFFFF !important;
      }

      .text-green-400 {
        color: #4ADE80 !important;
      }

      .text-blue-400 {
        color: #60A5FA !important;
      }

      .text-yellow-500 {
        color: #EAB308 !important;
      }
    }
  </style>
</head>

<body class="min-h-screen flex flex-col relative">
  <div class="shape shape-1"></div>
  <div class="shape shape-2"></div>
  <div class="shape shape-3"></div>
  <nav class="w-full p-6 flex justify-between items-center max-w-7xl mx-auto z-10 relative">
    <div
      class="text-xl font-bold font-heading tracking-tight flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity"
      id="brand-reset">
      <span class="text-2xl">üïµÔ∏è‚Äç‚ôÄÔ∏è</span> GEO Discoverer
    </div>
    <div class="text-sm text-gray-400 font-mono flex gap-3 items-center">
      <span class="hidden md:inline opacity-50">POWERED BY GEMINI 3</span>
      <span class="bg-blue-900/30 text-blue-400 px-2 py-1 rounded text-xs border border-blue-900">v1.0 BETA</span>
    </div>
  </nav>
  <div id="view-home"
    class="flex-grow flex flex-col lg:flex-row items-center justify-center max-w-7xl mx-auto w-full px-6 pb-12 fade-in z-10 relative gap-12 h-full">
    <div class="flex-1 text-left">
      <div class="system-badge mb-6">> SYSTEM_READY // AI_DISCOVERY_MODULE</div>
      <h1 class="hero-title mb-6 text-white">SEE HOW AI SHOWS<br>YOUR BRAND <span class="highlight-blue">TO
          PEOPLE</span>
      </h1>
      <p class="text-gray-400 text-lg max-w-lg leading-relaxed mb-8">Stop guessing. See exactly who finds your brand on
        ChatGPT, Claude, Gemini, and how.</p>
      <div class="flex flex-wrap gap-4 text-sm font-mono text-gray-500">
        <div class="flex items-center gap-2"><span class="text-green-500">‚úì</span> 25 Parallel Sims</div>
        <div class="flex items-center gap-2"><span class="text-green-500">‚úì</span> Agentic Evals</div>
        <div class="flex items-center gap-2"><span class="text-green-500">‚úì</span> Context Simulator</div>
      </div>
    </div>
    <div class="flex-1 w-full max-w-md">
      <div class="input-card rounded-2xl p-8 w-full">
        <div class="mb-6 pb-4 border-b border-gray-800">
          <h3 class="text-lg font-bold text-white mb-1">Run Discovery Audit</h3>
          <p class="text-xs text-gray-400">Enter your details to start the agentic workflow.</p>
        </div>
        <form id="discoveryForm">
          <div class="space-y-5">
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Target Brand *</label>
              <input type="text" id="companyName"
                class="w-full rounded-lg p-4 text-base focus:ring-2 focus:ring-blue-500 bg-[#0d1117] border-gray-700 text-white placeholder-gray-600"
                placeholder="e.g. Tanka.ai" required>
            </div>
            <div>
              <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Website URL</label>
              <input type="url" id="websiteUrl"
                class="w-full rounded-lg p-4 text-base focus:ring-2 focus:ring-blue-500 bg-[#0d1117] border-gray-700 text-white placeholder-gray-600"
                placeholder="e.g. https://yourbrand.com">
            </div>
            <button type="submit"
              class="vibrant-button w-full py-4 text-lg mt-2 flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20">Discover
              Now <span>‚Üí</span></button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div id="view-loading" class="hidden flex-grow flex flex-col items-center justify-center p-4 z-10 relative h-full">
    <div class="w-full max-w-xl text-center">
      <div class="system-badge mb-8 animate-pulse">> RUNNING_AGENTS // <span id="loadingBrandName">TARGET</span></div>
      <div class="input-card rounded-2xl p-8 text-left space-y-6">
        <div id="log-container" class="space-y-4 font-mono text-sm h-48 overflow-y-auto"></div>
        <div class="w-full bg-gray-800 rounded-full h-1 mt-8 overflow-hidden">
          <div id="progressBar" class="bg-blue-500 h-1 progress-fill" style="width:0%"></div>
        </div>
      </div>
      <p class="text-gray-500 text-sm mt-6 animate-pulse">Injecting System Prompts & Context Vectors...</p>
      <div
        class="mt-10 flex items-start gap-4 p-5 rounded-xl border border-dashed border-gray-800 bg-gray-900/30 text-left max-w-lg mx-auto">
        <div class="text-2xl mt-1">‚è±Ô∏è</div>
        <div>
          <h4 class="text-blue-400 font-bold font-heading text-sm mb-1 tracking-wide">ESTIMATED TIME: ~5 MINUTES</h4>
          <p class="text-gray-500 text-xs leading-relaxed">You can bookmark this page and return later. The agents will
            continue working in the background.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Modal -->
  <div id="custom-modal"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
    <div
      class="bg-[#161B22] border border-gray-800 rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-200"
      id="modal-content">
      <h3 class="text-xl font-bold font-heading text-white mb-2">Start New Analysis?</h3>
      <p class="text-gray-400 text-sm mb-8 leading-relaxed">
        Warning: You will not be able to return to this report after starting a new analysis.
      </p>
      <div class="flex gap-3 justify-end">
        <button id="modal-cancel" class="secondary-button px-6 py-2 text-sm">Cancel</button>
        <button id="modal-confirm" class="vibrant-button px-6 py-2 text-sm">Continue</button>
      </div>
    </div>
  </div>

  <!-- Result Viewer Modal -->
  <div id="result-modal"
    class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity duration-200 opacity-0">
    <div
      class="bg-[#161B22] border border-gray-800 rounded-2xl p-0 max-w-2xl w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-200 flex flex-col max-h-[80vh]"
      id="result-modal-content">
      <div class="p-6 border-b border-gray-800 flex justify-between items-center">
        <h3 class="text-xl font-bold font-heading text-white" id="result-modal-title">Result Details</h3>
        <button id="result-modal-close" class="text-gray-400 hover:text-white transition-colors">‚úï</button>
      </div>
      <div class="p-6 overflow-y-auto bg-[#0D1117] rounded-b-2xl">
        <pre id="result-modal-body" class="whitespace-pre-wrap font-mono text-sm text-gray-300 leading-relaxed"></pre>
      </div>
    </div>
  </div>

  <div id="view-dashboard" class="hidden flex-grow p-6 md:p-12 max-w-7xl mx-auto w-full fade-in z-10 relative h-full">
    <div
      class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 border-b border-gray-800 pb-8">
      <div>
        <div class="system-badge mb-2">> REPORT_GENERATED</div>
        <h1 class="text-4xl font-bold font-heading">Visibility Report: <span id="dashBrandName"
            class="text-white"></span></h1>
      </div>
      <div class="flex gap-3 mt-4 md:mt-0">
        <button id="downloadBtn" class="secondary-button px-4 py-2 text-sm flex items-center gap-2">Download
          PDF</button>
        <button id="newBtn" class="vibrant-button px-6 py-2 text-sm">+ New Analysis</button>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
      <div class="metric-card rounded-xl p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">üèÜ</div>
        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Winning Persona</div>
        <div id="dynamic-winning-persona" class="text-2xl font-bold text-white font-heading"></div>
        <div class="text-xs text-green-400 mt-3 font-mono bg-green-400/10 inline-block px-2 py-1 rounded">HIGH
          CONFIDENCE</div>
      </div>
      <div class="metric-card rounded-xl p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">üìà</div>
        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Discovery Score</div>
        <div id="dynamic-discovery-score" class="text-2xl font-bold text-white font-heading"></div>
        <div id="score-level-badge"
          class="text-xs text-blue-400 mt-3 font-mono bg-blue-400/10 inline-block px-2 py-1 rounded">CALCULATING...
        </div>
      </div>
      <div class="metric-card rounded-xl p-6 relative overflow-hidden group">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity text-6xl">‚öîÔ∏è</div>
        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Main Rival</div>
        <div id="dynamic-competitor" class="text-2xl font-bold text-white font-heading"></div>
        <div class="text-xs text-yellow-500 mt-3 font-mono bg-yellow-500/10 inline-block px-2 py-1 rounded">
          CO-OCCURRENCE: HIGH</div>
      </div>
    </div>

    <!-- NEW: Score Breakdown Section -->
    <div class="bg-[#1F2937] border border-[#374151] rounded-xl p-6 mb-12">
      <h3 class="text-2xl font-bold font-heading mb-6">Strategic Analysis</h3>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left: AI Narrative -->
        <div class="lg:col-span-1">
          <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Assessment</h4>
          <p id="dynamic-score-explanation" class="text-gray-300 leading-relaxed font-light text-sm">
            <span class="animate-pulse">Waiting for analysis...</span>
          </p>
        </div>

        <!-- Right: Visualization & Data -->
        <div class="lg:col-span-2">
          <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Score Contribution (Max 20pts each)
          </h4>
          <div id="score-chart-container" class="space-y-3 mb-6"></div>

          <details class="group">
            <summary
              class="text-xs text-blue-400 cursor-pointer hover:text-blue-300 flex items-center gap-2 select-none">
              <span>‚ñ∂ Show Calculation Details</span>
            </summary>
            <div class="mt-4 overflow-hidden rounded-lg border border-gray-800">
              <table class="w-full text-left text-xs">
                <thead class="bg-gray-800 text-gray-400">
                  <tr>
                    <th class="p-2">Persona</th>
                    <th class="p-2">Win Rate</th>
                    <th class="p-2">Realism</th>
                    <th class="p-2">Reach</th>
                    <th class="p-2 text-right">Points</th>
                  </tr>
                </thead>
                <tbody id="score-table-body" class="text-gray-300 divide-y divide-gray-800"></tbody>
              </table>
            </div>
            <p class="text-[10px] text-gray-500 mt-2">Formula: Points = Win Rate √ó Prompt Realism √ó Persona Reach √ó 20</p>
          </details>
        </div>
      </div>
    </div>
    <!-- END NEW SECTION -->

    <div class="mb-12">
      <h3 class="text-2xl font-bold font-heading mb-2">Discovery Paths</h3>
      <p class="text-gray-400 mb-6">We simulated 5 User Personas to find your "Golden Path".</p>
      <div class="overflow-hidden rounded-xl border border-gray-800 bg-[#161B22]">
        <table class="w-full text-left border-collapse geo-table">
          <thead>
            <tr>
              <th class="p-5 pl-6">Persona</th>
              <th class="p-5">Trigger Prompt</th>
              <th class="p-5">Frequency</th>
              <th class="p-5">Competitors</th>
              <th class="p-5">Results</th>
              <th class="p-5">Attribution</th>
              <th class="p-5">Sources</th>
            </tr>
          </thead>
          <tbody class="text-sm text-gray-300" id="results-table-body"></tbody>
        </table>
      </div>
    </div>
    <div class="mb-20" id="debugger"></div>
    <div class="text-center pb-8">
      <div class="text-gray-600 text-xs uppercase tracking-widest">GEO Discoverer v1.0 ‚Ä¢ Hackathon Edition</div>
    </div>
  </div>
  <script>
    const views = { home: document.getElementById('view-home'), loading: document.getElementById('view-loading'), dashboard: document.getElementById('view-dashboard') };
    let currentJobId = null;
    let currentResults = null;
    let pollingInterval = null;
    let dashboardShown = false;
    let currentEventSource = null;  // Track EventSource to close on new simulation

    function switchView(v) { 
      Object.values(views).forEach(el => el.classList.add('hidden')); 
      views[v].classList.remove('hidden'); 
      if (v === 'dashboard') { 
        document.body.classList.remove('overflow-hidden');
      }
    }

    function setProgress(p) { document.getElementById('progressBar').style.width = p + '%' }
    
    function addLog(t) { 
      const c = document.getElementById('log-container'); 
      const d = document.createElement('div'); 
      d.className = 'flex items-center gap-3 fade-in'; 
      d.innerHTML = '<span class="text-blue-500 font-bold">></span> <span class="text-gray-300">' + t + '</span>'; 
      c.appendChild(d); 
      c.scrollTop = c.scrollHeight;
    }

    async function createJob(brand, site) { 
      const r = await fetch('/api/discover', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ brand_name: brand, website_url: site }) }); 
      if (!r.ok) { 
        let errorMsg = 'job create failed'; 
        try { const errorData = await r.json(); errorMsg = errorData.error || errorMsg; } catch (e) { errorMsg = `${errorMsg} (${r.status} ${r.statusText})`; } 
        throw new Error(errorMsg); 
      } 
      return r.json();
    }

    function streamLogs(job_id) { 
      return new Promise((resolve) => { 
        // Close any existing EventSource before creating new one
        if (currentEventSource) {
          currentEventSource.close();
          currentEventSource = null;
        }
        
        const es = new EventSource('/api/discover/stream?job_id=' + job_id);
        currentEventSource = es;  // Store reference for cleanup
        let i = 0; 
        
        es.onopen = () => { 
          console.log('Stream connected'); 
          addLog('Connected to backend...'); 
        }; 
        
        es.onerror = (err) => { 
          console.error('Stream error:', err); 
          addLog('Stream connection error'); 
          es.close(); 
          resolve(false); 
        }; 
        
        es.onmessage = (e) => { 
          const m = e.data || ''; 
          console.log('Stream message:', m); 
          
          // Switch to dashboard when Stage 3 starts
          if (m.includes('Stage 3') && !dashboardShown) {
            dashboardShown = true;
            switchView('dashboard');
            renderInitialDashboard();
            startPolling(job_id);
          }
          
          if (m.startsWith('> COMPLETED')) { 
            es.close(); 
            stopPolling();
            resolve(true);
          } else if (m.startsWith('> FAILED')) { 
            es.close(); 
            stopPolling();
            resolve(false);
          } else if (m.startsWith('> CANCELLED')) { 
            es.close(); 
            stopPolling();
            resolve(false);
          } else { 
            addLog(m); 
            i++; 
            setProgress(Math.min(100, 20 + i * 5));
          }
        };
      });
    }

    async function fetchPartialResult(job_id) { 
      const r = await fetch('/api/discover/partial?job_id=' + job_id); 
      if (!r.ok) throw new Error('partial result fetch failed'); 
      return r.json();
    }

    async function fetchResult(job_id) { 
      const r = await fetch('/api/discover/result?job_id=' + job_id); 
      if (!r.ok) throw new Error('result fetch failed'); 
      return r.json();
    }

    // Initialize dashboard with skeleton/loading states
    function renderInitialDashboard() {
      const brand = document.getElementById('companyName').value;
      document.getElementById('dashBrandName').innerText = brand;
      
      // Set loading states for metrics
      document.getElementById('dynamic-winning-persona').innerHTML = '<div class="skeleton skeleton-text w-32 h-6"></div>';
      document.getElementById('dynamic-discovery-score').innerHTML = '<span class="updating">--/100</span>';
      document.getElementById('dynamic-competitor').innerHTML = '<div class="skeleton skeleton-text w-24 h-6"></div>';
      
      // Update badge to show live status
      const badge = document.getElementById('score-level-badge');
      badge.className = 'text-xs text-blue-400 mt-3 font-mono bg-blue-400/10 inline-block px-2 py-1 rounded';
      badge.innerHTML = '<span class="live-indicator"><span class="live-dot"></span>ANALYZING...</span>';
      
      // Set loading state for strategic analysis
      document.getElementById('dynamic-score-explanation').innerHTML = '<span class="updating text-gray-500">Generating strategic analysis...</span>';
      
      // Clear chart and table
      document.getElementById('score-chart-container').innerHTML = '<div class="text-gray-500 text-xs updating">Calculating score breakdown...</div>';
      document.getElementById('score-table-body').innerHTML = '';
      
      // Clear paths table
      document.getElementById('results-table-body').innerHTML = '';
      document.getElementById('debugger').innerHTML = '';
    }

    // Start polling for partial results
    function startPolling(job_id) {
      if (pollingInterval) clearInterval(pollingInterval);
      
      pollingInterval = setInterval(async () => {
        try {
          const res = await fetchPartialResult(job_id);
          renderProgressiveResults(res);
          
          if (res.status === 'completed') {
            stopPolling();
            currentResults = res;
            renderFinalResults(res);
          }
        } catch (err) {
          console.error('Polling error:', err);
        }
      }, 1000); // Poll every second
    }

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    // Render partial results progressively
    function renderProgressiveResults(res) {
      const tbody = document.getElementById('results-table-body');
      const existingRows = tbody.querySelectorAll('tr');
      
      (res.paths || []).forEach((p, pIdx) => {
        let tr = existingRows[pIdx];
        const isNew = !tr;
        
        if (isNew) {
          tr = document.createElement('tr');
          tr.className = 'group cursor-pointer transition-colors hover:bg-[#1c2128] row-animate';
          tr.style.animationDelay = `${pIdx * 100}ms`;
          tbody.appendChild(tr);
        }
        
        const barPct = Math.round(100 * p.frequency_count / p.frequency_total);
        const isAnalyzing = !p.analysis_complete;
        
        // Sources Links
        let sourcesHtml = '';
        if (p.sources && p.sources.length > 0) {
          sourcesHtml = p.sources.map(s => {
            try {
              return `<a href="${s}" target="_blank" class="text-blue-400 hover:text-blue-300 underline block truncate max-w-[150px] text-xs mb-1">${new URL(s).hostname}</a>`;
            } catch { return ''; }
          }).join('');
        } else if (isAnalyzing) {
          sourcesHtml = '<span class="skeleton skeleton-text-sm inline-block w-20 h-3"></span>';
        }

        // Results Links
        let resultsHtml = '';
        if (p.trial_responses && p.trial_responses.length > 0) {
          resultsHtml = p.trial_responses.map((r, rIdx) => {
            const safeContent = r.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/"/g, '&quot;');
            return `<button onclick="event.stopPropagation(); openResultModal('Result ${rIdx + 1} - ${p.persona_name}', \`${safeContent}\`)" class="text-green-400 hover:text-green-300 hover:underline text-xs block mb-1 text-left">Result ${rIdx + 1}</button>`;
          }).join('');
        }

        // Status indicator
        const statusDot = isAnalyzing 
          ? '<span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>'
          : '<span class="w-2 h-2 rounded-full bg-green-500"></span>';

        tr.innerHTML = `
          <td class="p-5 pl-6 font-medium text-white">
            <div class="flex items-center gap-3">${statusDot}${p.persona_name}</div>
          </td>
          <td class="p-5 font-mono text-xs text-blue-300 min-w-[200px]">${p.trigger_prompt}</td>
          <td class="p-5">
            <div class="flex items-center gap-2">
              <div class="w-16 h-1.5 bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full ${isAnalyzing ? 'bg-yellow-500' : 'bg-green-500'} transition-all duration-500" style="width:${barPct}%"></div>
              </div>
              <span class="text-xs font-bold ${isAnalyzing ? 'text-yellow-500 updating' : 'text-green-500'}">${isAnalyzing ? '...' : p.frequency_count + '/' + p.frequency_total}</span>
            </div>
          </td>
          <td class="p-5 text-xs">${isAnalyzing ? '<span class="skeleton skeleton-text-sm inline-block w-24 h-3"></span>' : (p.competitors || []).join(', ')}</td>
          <td class="p-5 text-xs min-w-[100px]">${resultsHtml}</td>
          <td class="p-5 text-xs text-gray-400 italic min-w-[200px]">${isAnalyzing ? '<span class="updating">Analyzing...</span>' : p.attribution}</td>
          <td class="p-5 text-xs">${sourcesHtml}</td>
        `;
      });

      // Update top metrics if available
      if (res.top_persona) {
        document.getElementById('dynamic-winning-persona').innerText = res.top_persona;
      }
      if (res.top_competitor) {
        document.getElementById('dynamic-competitor').innerText = res.top_competitor;
      }
    }

    // Render final results with all animations complete
    function renderFinalResults(res) {
      // Update badge to show completion
      const badge = document.getElementById('score-level-badge');
      const level = res.score_level || 'LOW';
      if (level === 'HIGH') {
        badge.className = 'text-xs text-green-400 mt-3 font-mono bg-green-400/10 inline-block px-2 py-1 rounded';
        badge.innerText = 'HIGH VISIBILITY';
      } else if (level === 'MEDIUM') {
        badge.className = 'text-xs text-blue-400 mt-3 font-mono bg-blue-400/10 inline-block px-2 py-1 rounded';
        badge.innerText = 'MODERATE';
      } else {
        badge.className = 'text-xs text-red-400 mt-3 font-mono bg-red-400/10 inline-block px-2 py-1 rounded';
        badge.innerText = 'LOW VISIBILITY';
      }

      // Update score with animation
      const scoreEl = document.getElementById('dynamic-discovery-score');
      scoreEl.classList.add('updating');
      setTimeout(() => {
        scoreEl.innerText = (res.discovery_score || 0) + '/100';
        scoreEl.classList.remove('updating');
      }, 300);

      // Update strategic analysis
      document.getElementById('dynamic-score-explanation').innerText = res.score_explanation || 'No analysis available.';

      // Render score breakdown chart
      const chartContainer = document.getElementById('score-chart-container');
      const tableBody = document.getElementById('score-table-body');
      chartContainer.innerHTML = '';
      tableBody.innerHTML = '';

      (res.score_breakdown || []).forEach((item, idx) => {
        const widthPct = (item.points / 20) * 100;
        let colorClass = 'bg-red-500';
        if (item.points >= 12) colorClass = 'bg-green-500';
        else if (item.points >= 6) colorClass = 'bg-yellow-500';

        // Format realism and reach for display
        const realism = item.prompt_realism !== undefined ? item.prompt_realism : (item.complexity_multiplier || 0.5);
        const reach = item.persona_reach !== undefined ? item.persona_reach : 0.7;
        const reachCategory = item.reach_category || 'Broad Vertical';

        const chartRow = document.createElement('div');
        chartRow.className = 'flex items-center gap-3 text-xs row-animate';
        chartRow.style.animationDelay = `${idx * 100}ms`;
        chartRow.innerHTML = `
          <div class="w-24 truncate text-gray-400" title="${item.persona}">${item.persona}</div>
          <div class="flex-grow bg-gray-800 h-2 rounded-full overflow-hidden">
            <div class="${colorClass} h-full transition-all duration-500" style="width: ${widthPct}%"></div>
          </div>
          <div class="w-8 text-right font-mono text-white">${item.points}</div>
        `;
        chartContainer.appendChild(chartRow);

        // Color code realism and reach
        const realismColor = realism >= 0.8 ? 'text-green-400' : realism >= 0.5 ? 'text-yellow-400' : 'text-red-400';
        const reachColor = reach >= 0.8 ? 'text-green-400' : reach >= 0.5 ? 'text-yellow-400' : 'text-red-400';

        tableBody.innerHTML += `
          <tr>
            <td class="p-2">${item.persona}</td>
            <td class="p-2 font-mono">${item.win_rate}%</td>
            <td class="p-2"><span class="${realismColor}" title="${item.realism_reasoning || ''}">${realism.toFixed(1)}</span></td>
            <td class="p-2"><span class="${reachColor}" title="${item.reach_reasoning || ''}">${reach.toFixed(1)} <span class="text-gray-500 text-[9px]">(${reachCategory})</span></span></td>
            <td class="p-2 text-right font-mono font-bold text-white">${item.points}</td>
          </tr>
        `;
      });

      // Re-render paths table with final data
      renderResults(res);
    }

    // Result Modal Logic
    const resultModal = document.getElementById('result-modal');
    const resultModalContent = document.getElementById('result-modal-content');
    const resultBody = document.getElementById('result-modal-body');
    const resultTitle = document.getElementById('result-modal-title');

    function openResultModal(title, content) {
      resultTitle.innerText = title;
      resultBody.innerText = content;
      resultModal.classList.remove('hidden');
      setTimeout(() => {
        resultModal.classList.remove('opacity-0');
        resultModalContent.classList.remove('scale-95');
        resultModalContent.classList.add('scale-100');
      }, 10);
    }

    function closeResultModal() {
      resultModal.classList.add('opacity-0');
      resultModalContent.classList.remove('scale-100');
      resultModalContent.classList.add('scale-95');
      setTimeout(() => {
        resultModal.classList.add('hidden');
      }, 200);
    }

    document.getElementById('result-modal-close').addEventListener('click', closeResultModal);
    resultModal.addEventListener('click', (e) => {
      if (e.target === resultModal) closeResultModal();
    });

    function renderResults(res) {
      document.getElementById('dashBrandName').innerText = res.brand_name;
      document.getElementById('dynamic-winning-persona').innerText = res.top_persona || '';
      document.getElementById('dynamic-discovery-score').innerText = (res.discovery_score || 0) + '/100';
      
      const badge = document.getElementById('score-level-badge');
      const level = res.score_level || 'LOW';
      if (level === 'HIGH') {
        badge.className = 'text-xs text-green-400 mt-3 font-mono bg-green-400/10 inline-block px-2 py-1 rounded';
        badge.innerText = 'HIGH VISIBILITY';
      } else if (level === 'MEDIUM') {
        badge.className = 'text-xs text-blue-400 mt-3 font-mono bg-blue-400/10 inline-block px-2 py-1 rounded';
        badge.innerText = 'MODERATE';
      } else {
        badge.className = 'text-xs text-red-400 mt-3 font-mono bg-red-400/10 inline-block px-2 py-1 rounded';
        badge.innerText = 'LOW VISIBILITY';
      }
      document.getElementById('dynamic-competitor').innerText = res.top_competitor || '';

      document.getElementById('dynamic-score-explanation').innerText = res.score_explanation || 'No analysis available.';

      const chartContainer = document.getElementById('score-chart-container');
      const tableBody = document.getElementById('score-table-body');
      chartContainer.innerHTML = '';
      tableBody.innerHTML = '';

      (res.score_breakdown || []).forEach(item => {
        const widthPct = (item.points / 20) * 100;
        let colorClass = 'bg-red-500';
        if (item.points >= 12) colorClass = 'bg-green-500';
        else if (item.points >= 6) colorClass = 'bg-yellow-500';

        // Format realism and reach for display
        const realism = item.prompt_realism !== undefined ? item.prompt_realism : (item.complexity_multiplier || 0.5);
        const reach = item.persona_reach !== undefined ? item.persona_reach : 0.7;
        const reachCategory = item.reach_category || 'Broad Vertical';

        chartContainer.innerHTML += `
          <div class="flex items-center gap-3 text-xs">
            <div class="w-24 truncate text-gray-400" title="${item.persona}">${item.persona}</div>
            <div class="flex-grow bg-gray-800 h-2 rounded-full overflow-hidden">
              <div class="${colorClass} h-full transition-all duration-500" style="width: ${widthPct}%"></div>
            </div>
            <div class="w-8 text-right font-mono text-white">${item.points}</div>
          </div>
        `;

        // Color code realism and reach
        const realismColor = realism >= 0.8 ? 'text-green-400' : realism >= 0.5 ? 'text-yellow-400' : 'text-red-400';
        const reachColor = reach >= 0.8 ? 'text-green-400' : reach >= 0.5 ? 'text-yellow-400' : 'text-red-400';

        tableBody.innerHTML += `
          <tr>
            <td class="p-2">${item.persona}</td>
            <td class="p-2 font-mono">${item.win_rate}%</td>
            <td class="p-2"><span class="${realismColor}" title="${item.realism_reasoning || ''}">${realism.toFixed(1)}</span></td>
            <td class="p-2"><span class="${reachColor}" title="${item.reach_reasoning || ''}">${reach.toFixed(1)} <span class="text-gray-500 text-[9px]">(${reachCategory})</span></span></td>
            <td class="p-2 text-right font-mono font-bold text-white">${item.points}</td>
          </tr>
        `;
      });

      const tbody = document.getElementById('results-table-body');
      tbody.innerHTML = '';

      (res.paths || []).forEach((p, pIdx) => {
        const tr = document.createElement('tr');
        tr.className = 'group cursor-pointer transition-colors hover:bg-[#1c2128]';
        const barPct = Math.round(100 * p.frequency_count / p.frequency_total);

        let sourcesHtml = '';
        (p.sources || []).forEach(s => {
          try {
            sourcesHtml += `<a href="${s}" target="_blank" class="text-blue-400 hover:text-blue-300 underline block truncate max-w-[150px] text-xs mb-1">${new URL(s).hostname}</a>`;
          } catch {}
        });

        const resultsHtml = (p.trial_responses || []).map((r, rIdx) => {
          const safeContent = r.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/"/g, '&quot;');
          return `<button onclick="event.stopPropagation(); openResultModal('Result ${rIdx + 1} - ${p.persona_name}', \`${safeContent}\`)" class="text-green-400 hover:text-green-300 hover:underline text-xs block mb-1 text-left">Result ${rIdx + 1}</button>`;
        }).join('');

        tr.innerHTML = `
          <td class="p-5 pl-6 font-medium text-white"><div class="flex items-center gap-3"><span class="w-2 h-2 rounded-full bg-green-500"></span>${p.persona_name}</div></td>
          <td class="p-5 font-mono text-xs text-blue-300 min-w-[200px]">${p.trigger_prompt}</td>
          <td class="p-5"><div class="flex items-center gap-2"><div class="w-16 h-1.5 bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-green-500" style="width:${barPct}%"></div></div><span class="text-xs font-bold text-green-500">${p.frequency_count}/${p.frequency_total}</span></div></td>
          <td class="p-5 text-xs">${(p.competitors || []).join(', ')}</td>
          <td class="p-5 text-xs min-w-[100px]">${resultsHtml}</td>
          <td class="p-5 text-xs text-gray-400 italic min-w-[200px]">${p.attribution}</td>
          <td class="p-5 text-xs">${sourcesHtml}</td>`;
        tbody.appendChild(tr);
      });

      const dbg = document.getElementById('debugger');
      dbg.innerHTML = '';
      (res.debug || []).forEach((d, i) => {
        const details = document.createElement('details');
        details.className = 'mb-4 group';
        details.open = i === 0;
        details.innerHTML = `<summary class="p-4 bg-[#161B22] rounded-lg flex items-center justify-between border border-gray-800 hover:border-gray-600 transition-all"><div class="flex items-center gap-3"><span class="text-green-500 font-bold">‚úÖ Analysis</span></div><div class="text-green-400 text-xs font-mono font-bold border border-green-900 bg-green-900/20 px-2 py-1 rounded">VISIBILITY</div></summary><div class="p-6 bg-[#0D1117] border-x border-b border-gray-800 rounded-b-lg"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><div class="text-xs text-gray-500 font-bold uppercase mb-2 tracking-wider">System Injection (Memory)</div><div class="code-window p-4 text-green-300 leading-relaxed"><div class="code-header mb-3 -mx-4 -mt-4"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>${d.hidden_memory.replace(/\n/g, '<br>')}</div></div><div><div class="text-xs text-gray-500 font-bold uppercase mb-2 tracking-wider">User Trigger</div><div class="code-window p-4 text-blue-300 leading-relaxed"><div class="code-header mb-3 -mx-4 -mt-4"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div>${d.trigger_prompt}</div></div></div></div>`;
        dbg.appendChild(details);
      });
    }

    // Cancel any existing job and close EventSource
    async function cancelCurrentJob() {
      // Close existing EventSource first to stop receiving old logs
      if (currentEventSource) {
        currentEventSource.close();
        currentEventSource = null;
        console.log('Closed previous EventSource');
      }
      
      if (currentJobId) {
        try {
          await fetch('/api/discover/cancel?job_id=' + currentJobId, { method: 'POST' });
          console.log('Cancelled previous job:', currentJobId);
        } catch (err) {
          console.log('Could not cancel previous job:', err);
        }
      }
    }

    async function startSimulation(e) { 
      e.preventDefault(); 
      const brand = document.getElementById('companyName').value; 
      const site = document.getElementById('websiteUrl').value; 
      
      // Cancel any existing job before starting new one
      await cancelCurrentJob();
      
      // Reset state
      dashboardShown = false;
      stopPolling();
      document.getElementById('log-container').innerHTML = '';
      
      document.getElementById('loadingBrandName').innerText = brand; 
      document.getElementById('dashBrandName').innerText = brand; 
      switchView('loading'); 
      
      try { 
        const { job_id } = await createJob(brand, site); 
        currentJobId = job_id;
        const ok = await streamLogs(job_id); 
        
        if (!ok) { 
          addLog('Simulation failed'); 
          return;
        }
        
        // Fetch final results if not already shown
        if (!dashboardShown) {
          const res = await fetchResult(job_id); 
          currentResults = res; 
          switchView('dashboard'); 
          renderResults(res);
        } else {
          // Final fetch to ensure we have complete data
          const res = await fetchResult(job_id);
          currentResults = res;
          renderResults(res);
        }
      } catch (err) { 
        addLog('Error: ' + String(err));
      }
    }

    function downloadPDF() {
      if (!currentResults) { alert('No results available to download'); return; }
      window.print();
    }

    // Modal Logic
    const modal = document.getElementById('custom-modal');
    const modalContent = document.getElementById('modal-content');
    const openModal = () => {
      modal.classList.remove('hidden');
      setTimeout(() => {
        modal.classList.remove('opacity-0');
        modalContent.classList.remove('scale-95');
        modalContent.classList.add('scale-100');
      }, 10);
    };
    const closeModal = () => {
      modal.classList.add('opacity-0');
      modalContent.classList.remove('scale-100');
      modalContent.classList.add('scale-95');
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 200);
    };

    document.getElementById('discoveryForm').addEventListener('submit', startSimulation);
    document.getElementById('newBtn').addEventListener('click', openModal);

    document.getElementById('modal-cancel').addEventListener('click', closeModal);
    document.getElementById('modal-confirm').addEventListener('click', async () => {
      closeModal();
      // Cancel any running job
      await cancelCurrentJob();
      currentResults = null;
      currentJobId = null;
      dashboardShown = false;
      stopPolling();
      document.getElementById('log-container').innerHTML = '';
      setProgress(0);
      document.getElementById('discoveryForm').reset();
      switchView('home');
    });

    document.getElementById('downloadBtn').addEventListener('click', downloadPDF);
    document.getElementById('brand-reset').addEventListener('click', () => { 
      stopPolling();
      document.getElementById('discoveryForm').reset(); 
      switchView('home');
    });
  </script>
</body>

</html>